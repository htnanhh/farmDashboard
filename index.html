<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard IFrame ERA</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5fdf6;
      margin: 0;
      padding: 2rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }
    .section {
      background: #e9fbe8;
      border: 2px dashed #43a047;
      border-radius: 12px;
      padding: 1rem 1.5rem;
    }
    .section h3 {
      margin-top: 0;
      color: #2e7d32;
    }
    .sensor {
      padding: 0.4rem 0;
      font-size: 15px;
    }
    .sensor span {
      font-weight: bold;
    }
    .btn {
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1.2rem;
      margin: 0.3rem 0;
      width: 100%;
      font-size: 15px;
      cursor: pointer;
    }
    .btn:hover {
      background: #388e3c;
    }
  </style>
</head>
<body>
  <div class="grid">
    <div class="section">
      <h3>Node Điều Khiển 1 (Bơm)</h3>
      <button class="btn" id="pump1">🧯 Bơm nước</button>
      <button class="btn" id="pump2">🧪 Dung dịch A</button>
      <button class="btn" id="pump3">🧪 Dung dịch B</button>
      <button class="btn" id="pump4">🧪 Bơm HNO3</button>
    </div>

    <div class="section">
      <h3>Node Cảm Biến 1 (Đầu luống)</h3>
      <div class="sensor">🌡️ Nhiệt độ (DHT11): <span id="v4">--</span> °C</div>
      <div class="sensor">💧 Độ ẩm không khí: <span id="v5">--</span> %</div>
      <div class="sensor">🌱 Độ ẩm đất: <span id="v6">--</span> %</div>
      <div class="sensor">🌞 Ánh sáng: <span id="v3">--</span></div>
      <div class="sensor">⚡ Điện áp: <span id="v1">--</span> V</div>
      <div class="sensor">🔌 Dòng điện: <span id="v2">--</span> A</div>
      <div class="sensor">🧪 pH: <span id="v8">--</span></div>
      <div class="sensor">⚙️ EC: <span id="v7">--</span></div>
    </div>

    <div class="section">
      <h3>Node Điều Khiển 2 (Đèn chiếu sáng)</h3>
      <button class="btn" id="light1">💡 Bóng đèn 1</button>
      <button class="btn" id="light2">💡 Bóng đèn 2</button>
      <button class="btn" id="light3">💡 Bóng đèn 3</button>
    </div>

    <div class="section">
      <h3>Node Cảm Biến 2 (Cuối luống)</h3>
      <div class="sensor">🌡️ Nhiệt độ (SHT20): <span id="v12">--</span> °C</div>
      <div class="sensor">💧 Độ ẩm không khí: <span id="v13">--</span> %</div>
      <div class="sensor">🌱 Độ ẩm đất: <span id="v14">--</span> %</div>
      <div class="sensor">🌞 Ánh sáng: <span id="v11">--</span></div>
      <div class="sensor">⚡ Điện áp: <span id="v9">--</span> V</div>
      <div class="sensor">🔌 Dòng điện: <span id="v10">--</span> A</div>
    </div>
  </div>

  <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
  <script>
    const widget = new EraWidget();
    const sensorMap = {
      V1: 'v1', V2: 'v2', V3: 'v3', V4: 'v4', V5: 'v5', V6: 'v6', V7: 'v7', V8: 'v8',
      V9: 'v9', V10: 'v10', V11: 'v11', V12: 'v12', V13: 'v13', V14: 'v14'
    };

    let actions = [];
    let status = {}; // Lưu trạng thái hiện tại của các thiết bị relay

    widget.init({
      needRealtimeConfigs: true,
      needActions: true,
      maxRealtimeConfigsCount: 20,
      maxActionsCount: 20,
      onConfiguration: (config) => {
        window.realtimeConfigs = config.realtime_configs;
        actions = config.actions;
      },
      onValues: (values) => {
        for (const id in values) {
          const el = document.getElementById(sensorMap[id]);
          if (el) el.textContent = values[id].value;
        }
        // Lưu trạng thái thiết bị điều khiển (giả sử theo thứ tự relay tương ứng actions)
        actions.forEach((act, i) => {
          if (act.device && typeof values[act.device]?.value !== 'undefined') {
            status[act.device] = values[act.device].value;
          }
        });
      },
    });

    function toggleAction(device, actionOn, actionOff, buttonId) {
      const btn = document.getElementById(buttonId);
      btn?.addEventListener('click', () => {
        const isOn = status[device] == 1;
        const actionToSend = isOn ? actionOff : actionOn;
        widget.triggerAction(actionToSend.action, null);
      });
    }

    toggleAction('NODE 1 - Relay 1', actions[0], actions[1], 'pump1');
    toggleAction('NODE 1 - Relay 2', actions[2], actions[3], 'pump2');
    toggleAction('NODE 1 - Relay 3', actions[4], actions[5], 'pump3');
    toggleAction('NODE 1 - Relay 4', actions[6], actions[7], 'pump4');
    toggleAction('NODE 2 - Relay 1', actions[8], actions[9], 'light1');
    toggleAction('NODE 2 - Relay 2', actions[10], actions[11], 'light2');
    toggleAction('NODE 2 - Relay 3', actions[12], actions[13], 'light3');
  </script>
</body>
</html>
